# Fix for long URLs in map (ngrok URLs are long)
map_hash_bucket_size 128;

map $http_origin $cors_origin {
    default "";
    "http://localhost:5173"  "http://localhost:5173";
    "http://localhost:3000"  "http://localhost:3000";
    "https://photobathic-epiblastic-noble.ngrok-free.dev" "https://photobathic-epiblastic-noble.ngrok-free.dev";
}

# ========================
# Upstream Services
# ========================

upstream user_service {
    server user-service:3001;
    keepalive 32;
}

upstream post_service {
    server post-service:3002;
    keepalive 32;
}

upstream social_service {
    server social-service:3003;
    keepalive 32;
}

upstream feed_service {
    server feed-service:3004;
    keepalive 32;
}

upstream media_service {
    server media-service:3005;
    keepalive 32;
}

upstream notification_service {
    server notification-service:3006;
    keepalive 32;
}

upstream search_service {
    server search-service:3007;
    keepalive 32;
}

# ========================
# Rate Limiting
# ========================

limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=2r/m;
limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=10r/m;

# ========================
# CORS Snippet (reused via include)
# ========================

# Main Server Block
server {
    listen 3000;
    server_name localhost;

    limit_req zone=api_limit burst=20 nodelay;
    limit_req_status 429;

    # ========================
    # Health Check
    # ========================
    location = /health {
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header Content-Type application/json;
        return 200 '{"status":"success","service":"nginx-gateway","timestamp":"$time_iso8601"}';
    }

    # ========================
    # User Service
    # ========================
    location = /api/v1/users/register {
        limit_req zone=auth_limit burst=5 nodelay;
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://user_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location = /api/v1/users/login {
        limit_req zone=auth_limit burst=5 nodelay;
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://user_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/v1/users {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://user_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ========================
    # Post Service
    # ========================
    location /api/v1/posts {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://post_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ========================
    # Social Service
    # ========================
    location /api/v1/follows {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://social_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/v1/likes {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://social_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/v1/comments {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://social_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ========================
    # Feed Service
    # ========================
    location /api/v1/feed {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://feed_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ========================
    # Media Service
    # ========================
    location /api/v1/media {
        limit_req zone=upload_limit burst=5 nodelay;
        client_max_body_size 10M;
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://media_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ========================
    # Notification Service
    # ========================
    location /api/v1/notifications {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://notification_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ========================
    # WebSocket
    # ========================
    location /ws {
        proxy_pass http://notification_service;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # ========================
    # Search Service
    # ========================
    location /api/v1/search {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Length' 0;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, ngrok-skip-browser-warning, x-user-id' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        proxy_pass http://search_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ========================
    # Error Pages
    # ========================
    error_page 404 = @not_found;
    location @not_found {
        add_header Content-Type application/json always;
        return 404 '{"status":"error","error":{"code":"NOT_FOUND","message":"Route not found"}}';
    }

    error_page 429 = @rate_limited;
    location @rate_limited {
        add_header Content-Type application/json always;
        return 429 '{"status":"error","error":{"code":"RATE_LIMIT_EXCEEDED","message":"Too many requests"}}';
    }

    error_page 502 503 504 = @service_unavailable;
    location @service_unavailable {
        add_header Content-Type application/json always;
        return 503 '{"status":"error","error":{"code":"SERVICE_UNAVAILABLE","message":"Service temporarily unavailable"}}';
    }
}