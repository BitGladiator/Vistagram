
# Upstream Service Definitions


upstream user_service {
    server user-service:3001;
    keepalive 32;
}

upstream post_service {
    server post-service:3002;
    keepalive 32;
}

upstream social_service {
    server social-service:3003;
    keepalive 32;
}

upstream feed_service {
    server feed-service:3004;
    keepalive 32;
}

upstream media_service {
    server media-service:3005;
    keepalive 32;
}

upstream notification_service {
    server notification-service:3006;
    keepalive 32;
}

upstream search_service {
    server search-service:3007;
    keepalive 32;
}



# Rate Limiting Zones


# General API rate limit: 100 req/min per IP
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/m;

# Auth rate limit: 20 req/15min per IP (stricter)
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=20r/15m;

# Upload rate limit: 10 req/min per IP
limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=10r/m;


# Main Server Block


server {
    listen 3000;
    server_name localhost;

    # Apply general rate limit
    limit_req zone=api_limit burst=20 nodelay;
    limit_req_status 429;

    
    # Health Check
   
    location /health {
        return 200 '{"status":"success","service":"nginx-gateway","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }


    # User Service
    # /api/v1/users/*
    location /api/v1/users/register {
        limit_req zone=auth_limit burst=5 nodelay;

        proxy_pass http://user_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/v1/users/login {
        limit_req zone=auth_limit burst=5 nodelay;

        proxy_pass http://user_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/v1/users {
        proxy_pass http://user_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }


    # Post Service
    # /api/v1/posts/*
    location /api/v1/posts {
        proxy_pass http://post_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Social Service
    # /api/v1/follows/*
    # /api/v1/likes/*
    # /api/v1/comments/*
    location /api/v1/follows {
        proxy_pass http://social_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/v1/likes {
        proxy_pass http://social_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    location /api/v1/comments {
        proxy_pass http://social_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Feed Service
    # /api/v1/feed/*
    location /api/v1/feed {
        proxy_pass http://feed_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Media Service
    # /api/v1/media/*
    location /api/v1/media {
        limit_req zone=upload_limit burst=5 nodelay;

        # Allow larger body for file uploads
        client_max_body_size 10M;

        proxy_pass http://media_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Notification Service
    # /api/v1/notifications/*
    location /api/v1/notifications {
        proxy_pass http://notification_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }


    # WebSocket for Notifications
    # /ws
    location /ws {
        proxy_pass http://notification_service;
        proxy_http_version 1.1;

        # WebSocket upgrade headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;

        # Longer timeout for WebSocket
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # Search Service
    # /api/v1/search/*
    location /api/v1/search {
        proxy_pass http://search_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }


    # Error Pages
    error_page 404 = @not_found;
    location @not_found {
        return 404 '{"status":"error","error":{"code":"NOT_FOUND","message":"Route not found"}}';
        add_header Content-Type application/json;
    }

    error_page 429 = @rate_limited;
    location @rate_limited {
        return 429 '{"status":"error","error":{"code":"RATE_LIMIT_EXCEEDED","message":"Too many requests"}}';
        add_header Content-Type application/json;
    }

    error_page 502 503 504 = @service_unavailable;
    location @service_unavailable {
        return 503 '{"status":"error","error":{"code":"SERVICE_UNAVAILABLE","message":"Service temporarily unavailable"}}';
        add_header Content-Type application/json;
    }
}