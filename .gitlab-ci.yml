stages:
  - test
  - build

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# ========================
# TEST STAGE
# ========================

test:user-service:
  image: node:18-alpine
  stage: test
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_USER: vistagram
    POSTGRES_PASSWORD: vistagram123
    POSTGRES_DB: vistagram
    POSTGRES_HOST_AUTH_METHOD: trust
    NODE_ENV: test
    DB_HOST: postgres
    DB_PORT: 5432
    DB_NAME: vistagram_users_test
    DB_USER: vistagram
    DB_PASSWORD: vistagram123
    JWT_SECRET: test-jwt-secret-key
    JWT_EXPIRES_IN: 15m
    BCRYPT_ROUNDS: 1
    ALLOWED_ORIGINS: http://localhost:3000
  before_script:
    - cd services/user-service
    - npm install
    - apk add --no-cache postgresql-client
    # Wait for postgres to be ready
    - |
      until pg_isready -h postgres -U vistagram; do
        echo "Waiting for postgres..."
        sleep 2
      done
    # Create test database
    - psql -h postgres -U vistagram -c "CREATE DATABASE vistagram_users_test;"
    # Run test schema (no \c command)
    - psql -h postgres -U vistagram -d vistagram_users_test -f ../../databases/postgres/schemas/02_users_schema_test.sql
  script:
    - npm test
  only:
    - main
    - develop
    - merge_requests

# ========================
# BUILD STAGE
# ========================

build:user-service:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        -t $CI_REGISTRY_IMAGE/user-service:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/user-service:latest \
        services/user-service
    - docker push $CI_REGISTRY_IMAGE/user-service:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/user-service:latest
  needs:
    - test:user-service
  only:
    - main

build:post-service:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        -t $CI_REGISTRY_IMAGE/post-service:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/post-service:latest \
        services/post-service
    - docker push $CI_REGISTRY_IMAGE/post-service:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/post-service:latest
  only:
    - main

build:social-service:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        -t $CI_REGISTRY_IMAGE/social-service:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/social-service:latest \
        services/social-service
    - docker push $CI_REGISTRY_IMAGE/social-service:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/social-service:latest
  only:
    - main

build:feed-service:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        -t $CI_REGISTRY_IMAGE/feed-service:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/feed-service:latest \
        services/feed-service
    - docker push $CI_REGISTRY_IMAGE/feed-service:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/feed-service:latest
  only:
    - main

build:media-service:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        -t $CI_REGISTRY_IMAGE/media-service:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/media-service:latest \
        services/media-service
    - docker push $CI_REGISTRY_IMAGE/media-service:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/media-service:latest
  only:
    - main

build:notification-service:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        -t $CI_REGISTRY_IMAGE/notification-service:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/notification-service:latest \
        services/notification-service
    - docker push $CI_REGISTRY_IMAGE/notification-service:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/notification-service:latest
  only:
    - main

build:search-service:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        -t $CI_REGISTRY_IMAGE/search-service:$CI_COMMIT_SHA \
        -t $CI_REGISTRY_IMAGE/search-service:latest \
        services/search-service
    - docker push $CI_REGISTRY_IMAGE/search-service:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/search-service:latest
  only:
    - main